{"title":"MySQL进阶(五)-性能优化篇","slug":"MySQL进阶-五-性能优化篇","date":"2023-04-04T15:52:08.000Z","updated":"2024-04-22T07:21:14.891Z","comments":true,"path":"api/articles/MySQL进阶-五-性能优化篇.json","excerpt":" MySQL数据库调优","covers":["http://file.hyqup.cn/img/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92Explain.png"],"content":"<p> MySQL数据库调优</p>\n<span id=\"more\"></span>\n\n<h2 id=\"调优范围\"><a href=\"#调优范围\" class=\"headerlink\" title=\"调优范围\"></a>调优范围</h2><ul>\n<li><p><strong>调SQL语句</strong>：根据需求创建结构良好的SQL语句</p>\n</li>\n<li><p><strong>调索引</strong>：索引创建原则</p>\n</li>\n<li><p><strong>调数据库表结构</strong></p>\n</li>\n<li><p><strong>调MySQL配置</strong>：最大连接数，连接超时，线程缓存，查询缓存，排序缓存，连接查询缓存…</p>\n</li>\n<li><p><strong>调MySQL宿主机OS</strong>：TCP连接数，打开文件数，线程栈大小</p>\n</li>\n<li><p><strong>调服务器硬件</strong>：更多核CPU、更大内存</p>\n</li>\n<li><p><strong>MySQL客户端</strong>：连接池（MaxActive，MaxWait），连接属性</p>\n</li>\n</ul>\n<h2 id=\"执行计划Explain\"><a href=\"#执行计划Explain\" class=\"headerlink\" title=\"执行计划Explain\"></a>执行计划Explain</h2><p><img src=\"http://file.hyqup.cn/img/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92Explain.png\" alt=\"执行计划Explain\"></p>\n<figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">user</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></div></figure>\n\n<h3 id=\"参数介绍\"><a href=\"#参数介绍\" class=\"headerlink\" title=\"参数介绍\"></a>参数介绍</h3><ul>\n<li><p>id：SELECT识别符，这是SELECT查询序列号。</p>\n</li>\n<li><p><strong>select_type</strong>：表示单位查询的查询类型，比如：普通查询、联合查询(union、union all)、查询等复杂查询。</p>\n</li>\n<li><p>table：表示查询的表</p>\n</li>\n<li><p>partitions：使用的哪些分区（对于非分区表值为null）。</p>\n</li>\n<li><p><strong>type</strong>（重要）表示表的连接类型。</p>\n</li>\n<li><p>possible_keys：此次查询中可能选用的索引</p>\n</li>\n<li><p>key：查询真正使用到的索引</p>\n</li>\n<li><p>key_len：显示MySQL决定使用的索引size</p>\n</li>\n<li><p>ref：哪个字段或常数与 key 一起被使用</p>\n</li>\n<li><p><strong>rows</strong>：显示此查询一共扫描了多少行，这个是一个估计值，不是精确的值。</p>\n</li>\n<li><p>filtered: 表示此查询条件所过滤的数据的百分比</p>\n</li>\n<li><p><strong>Extra</strong>：额外信息</p>\n</li>\n</ul>\n<h4 id=\"select-type参数\"><a href=\"#select-type参数\" class=\"headerlink\" title=\"select_type参数\"></a>select_type参数</h4><blockquote>\n<p>总体分为三大类，简单查询，连接查询，子查询</p>\n</blockquote>\n<ul>\n<li><p><strong>simple</strong> 简单查询</p>\n</li>\n<li><p><strong>primary</strong> 主表，多张表的时候有一张主表</p>\n</li>\n<li><p><strong>union</strong>：连接查询</p>\n</li>\n<li><p><strong>dependent union</strong> 依赖连接查询</p>\n</li>\n<li><p><strong>subquery</strong>：子查询</p>\n</li>\n<li><p><strong>dependent subquery</strong>：依赖子查询</p>\n</li>\n<li><p><strong>derived</strong>：派生表</p>\n</li>\n</ul>\n<h4 id=\"type参数\"><a href=\"#type参数\" class=\"headerlink\" title=\"type参数\"></a>type参数</h4><blockquote>\n<p>显示的是单位查询的<strong>连接类型</strong>或者理解为<strong>访问类型</strong></p>\n</blockquote>\n<figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">system\nconst\neq_ref\nref\nfulltext\nref_or_null\nunique_subquery\nindex_subquery\nrange\nindex_merge\n<span class=\"token keyword\">index</span>\n<span class=\"token keyword\">ALL</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>\n\n<h5 id=\"system\"><a href=\"#system\" class=\"headerlink\" title=\"system\"></a>system</h5><p>表中<strong>只有一行数据或者是空表</strong></p>\n<h5 id=\"const\"><a href=\"#const\" class=\"headerlink\" title=\"const\"></a><strong><code>const</code></strong></h5><p>使用<strong>唯一索引或者主键</strong></p>\n<p><strong><code>eq_ref</code></strong></p>\n<p><strong>唯一性索引扫描</strong></p>\n<h5 id=\"ref\"><a href=\"#ref\" class=\"headerlink\" title=\"ref\"></a><code>ref</code></h5><p><strong>非唯一性索</strong>引扫描</p>\n<h5 id=\"fulltext\"><a href=\"#fulltext\" class=\"headerlink\" title=\"fulltext\"></a><strong>fulltext</strong></h5><p>全文索引检索</p>\n<h5 id=\"ref-or-null\"><a href=\"#ref-or-null\" class=\"headerlink\" title=\"ref_or_null\"></a><strong>ref_or_null</strong></h5><p>与ref方法类似，只是增加了null值的比较</p>\n<h5 id=\"unique-subquery\"><a href=\"#unique-subquery\" class=\"headerlink\" title=\"unique_subquery\"></a><strong>unique_subquery</strong></h5><p>用于where中的in形式子查询，子查询返回不重复值唯一值</p>\n<h5 id=\"index-subquery\"><a href=\"#index-subquery\" class=\"headerlink\" title=\"index_subquery\"></a><strong>index_subquery</strong></h5><p>用于in形式子查询使用到了辅助索引或者in常数列表，子查询可能返回重复值，可以使用索引将子查询去重</p>\n<h5 id=\"range\"><a href=\"#range\" class=\"headerlink\" title=\"range\"></a><strong><code>range</code></strong></h5><p><strong>索引范围扫描</strong>，常见于使用&gt;,&lt;,is null,between ,in ,like等运算符的查询中</p>\n<h5 id=\"index-merge\"><a href=\"#index-merge\" class=\"headerlink\" title=\"index_merge\"></a><strong>index_merge</strong></h5><p>表示查询使用了两个以上的索引，最后取交集或者并集，常见and ，or的条件使用了不同的索引</p>\n<h5 id=\"index\"><a href=\"#index\" class=\"headerlink\" title=\"index\"></a><strong><code>index</code></strong></h5><p>select结果列中使用到了索引，type会显示为index。<strong>全部索引扫描</strong>，把索引从头到尾扫一遍，常见于使用索引列就可以处理不需要读取数据文件的查询、可以使用索引排序或者分组的查询</p>\n<h5 id=\"all\"><a href=\"#all\" class=\"headerlink\" title=\"all\"></a><strong><code>all</code></strong></h5><p>这个就是全表扫描数据文件，然后再<strong>在<strong><strong>server</strong></strong>层进行过滤</strong>返回符合要求的记录</p>\n<h4 id=\"Extra参数\"><a href=\"#Extra参数\" class=\"headerlink\" title=\"Extra参数\"></a><strong>Extra参数</strong></h4><ul>\n<li><p><strong>Using filesort</strong></p>\n<p>使用了文件排序</p>\n</li>\n<li><p><strong>Using index</strong></p>\n<p>表示相应的SELECT查询中使用到了索引，避免访问表的数据行，这种查询的效率很高！</p>\n</li>\n<li><p><strong>Using where</strong></p>\n<p>MySQL将对InnoDB提取的结果在SQL Layer层进行过滤</p>\n</li>\n<li><p><strong>Using join buffer</strong></p>\n<p>使用了连接缓存</p>\n</li>\n</ul>\n<h2 id=\"优化\"><a href=\"#优化\" class=\"headerlink\" title=\"优化\"></a>优化</h2><p>创建索引的原则，判断组合索引失效场景</p>\n<h3 id=\"慢查询\"><a href=\"#慢查询\" class=\"headerlink\" title=\"慢查询\"></a>慢查询</h3><p><strong>查看是否开启慢查询功能</strong></p>\n<figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\"># 查看是否开启慢查询日志</span>\n<span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'%slow_query%'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'long_query_time%'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></div></figure>\n\n<p>slow_query_log：是否开启慢查询日志，1为开启，0为关闭</p>\n<p>log-slow-queries：旧版（5.6以下）MySQL数据库慢查询日志存储路径。</p>\n<p>slow-query-log-file：新版（5.6及以上）MySQL数据库慢查询日志存储路径。</p>\n<p>​\t\t不设置该参数，系统则会默认给一个文件host_name-slow.log</p>\n<p>long_query_time：慢查询阈值，当查询时间多于设定的阈值时，记录日志，单位秒</p>\n<h3 id=\"开启慢查询\"><a href=\"#开启慢查询\" class=\"headerlink\" title=\"开启慢查询\"></a>开启慢查询</h3><figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\"># 开启慢查询日志</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> slow_query_log<span class=\"token operator\">=</span><span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 大于1秒钟的数据记录到慢日志中，如果设置为默认0，则会有大量的信息存储在磁盘中，磁盘很容易满</span>\n掉\n<span class=\"token comment\"># 如果设置不生效，建议配置在my.cnf配置文件中</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> long_query_time<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 记录没有索引的查询。</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> log_queries_not_using_indexes<span class=\"token operator\">=</span><span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>\n\n<h3 id=\"连接数max-connections\"><a href=\"#连接数max-connections\" class=\"headerlink\" title=\"连接数max_connections\"></a><strong>连接数</strong>max_connections</h3><figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\"># 查看 max_connections</span>\n<span class=\"token keyword\">show</span> <span class=\"token keyword\">global</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'max_connections'</span>\n<span class=\"token comment\"># 设置 max_connections（立即生效重启后失效）</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> max_connections <span class=\"token operator\">=</span> <span class=\"token number\">800</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 这台MySQL服务器最大连接数是256，然后查询一下服务器使用过的最大连接数：</span>\n<span class=\"token keyword\">show</span> <span class=\"token keyword\">global</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">like</span> <span class=\"token string\">'Max_used_connections'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># MySQL服务器过去的最大连接数是245，没有达到服务器连接数上限256，应该没有出现1040错误，</span>\n比较理想的设置是：Max_used_connections <span class=\"token operator\">/</span> max_connections <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> ≈ <span class=\"token number\">85</span><span class=\"token operator\">%</span>\n最大连接数占上限连接数的<span class=\"token number\">85</span><span class=\"token operator\">%</span>左右，如果发现比例在<span class=\"token number\">10</span><span class=\"token operator\">%</span>以下，MySQL服务器连接数上限设置的过高\n了<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>\n\n","more":"<h2 id=\"调优范围\"><a href=\"#调优范围\" class=\"headerlink\" title=\"调优范围\"></a>调优范围</h2><ul>\n<li><p><strong>调SQL语句</strong>：根据需求创建结构良好的SQL语句</p>\n</li>\n<li><p><strong>调索引</strong>：索引创建原则</p>\n</li>\n<li><p><strong>调数据库表结构</strong></p>\n</li>\n<li><p><strong>调MySQL配置</strong>：最大连接数，连接超时，线程缓存，查询缓存，排序缓存，连接查询缓存…</p>\n</li>\n<li><p><strong>调MySQL宿主机OS</strong>：TCP连接数，打开文件数，线程栈大小</p>\n</li>\n<li><p><strong>调服务器硬件</strong>：更多核CPU、更大内存</p>\n</li>\n<li><p><strong>MySQL客户端</strong>：连接池（MaxActive，MaxWait），连接属性</p>\n</li>\n</ul>\n<h2 id=\"执行计划Explain\"><a href=\"#执行计划Explain\" class=\"headerlink\" title=\"执行计划Explain\"></a>执行计划Explain</h2><p><img src=\"http://file.hyqup.cn/img/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92Explain.png\" alt=\"执行计划Explain\"></p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">EXPLAIN</span> <span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> <span class=\"token keyword\">user</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"参数介绍\"><a href=\"#参数介绍\" class=\"headerlink\" title=\"参数介绍\"></a>参数介绍</h3><ul>\n<li><p>id：SELECT识别符，这是SELECT查询序列号。</p>\n</li>\n<li><p><strong>select_type</strong>：表示单位查询的查询类型，比如：普通查询、联合查询(union、union all)、查询等复杂查询。</p>\n</li>\n<li><p>table：表示查询的表</p>\n</li>\n<li><p>partitions：使用的哪些分区（对于非分区表值为null）。</p>\n</li>\n<li><p><strong>type</strong>（重要）表示表的连接类型。</p>\n</li>\n<li><p>possible_keys：此次查询中可能选用的索引</p>\n</li>\n<li><p>key：查询真正使用到的索引</p>\n</li>\n<li><p>key_len：显示MySQL决定使用的索引size</p>\n</li>\n<li><p>ref：哪个字段或常数与 key 一起被使用</p>\n</li>\n<li><p><strong>rows</strong>：显示此查询一共扫描了多少行，这个是一个估计值，不是精确的值。</p>\n</li>\n<li><p>filtered: 表示此查询条件所过滤的数据的百分比</p>\n</li>\n<li><p><strong>Extra</strong>：额外信息</p>\n</li>\n</ul>\n<h4 id=\"select-type参数\"><a href=\"#select-type参数\" class=\"headerlink\" title=\"select_type参数\"></a>select_type参数</h4><blockquote>\n<p>总体分为三大类，简单查询，连接查询，子查询</p>\n</blockquote>\n<ul>\n<li><p><strong>simple</strong> 简单查询</p>\n</li>\n<li><p><strong>primary</strong> 主表，多张表的时候有一张主表</p>\n</li>\n<li><p><strong>union</strong>：连接查询</p>\n</li>\n<li><p><strong>dependent union</strong> 依赖连接查询</p>\n</li>\n<li><p><strong>subquery</strong>：子查询</p>\n</li>\n<li><p><strong>dependent subquery</strong>：依赖子查询</p>\n</li>\n<li><p><strong>derived</strong>：派生表</p>\n</li>\n</ul>\n<h4 id=\"type参数\"><a href=\"#type参数\" class=\"headerlink\" title=\"type参数\"></a>type参数</h4><blockquote>\n<p>显示的是单位查询的<strong>连接类型</strong>或者理解为<strong>访问类型</strong></p>\n</blockquote>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">system\nconst\neq_ref\nref\nfulltext\nref_or_null\nunique_subquery\nindex_subquery\nrange\nindex_merge\n<span class=\"token keyword\">index</span>\n<span class=\"token keyword\">ALL</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"system\"><a href=\"#system\" class=\"headerlink\" title=\"system\"></a>system</h5><p>表中<strong>只有一行数据或者是空表</strong></p>\n<h5 id=\"const\"><a href=\"#const\" class=\"headerlink\" title=\"const\"></a><strong><code>const</code></strong></h5><p>使用<strong>唯一索引或者主键</strong></p>\n<p><strong><code>eq_ref</code></strong></p>\n<p><strong>唯一性索引扫描</strong></p>\n<h5 id=\"ref\"><a href=\"#ref\" class=\"headerlink\" title=\"ref\"></a><code>ref</code></h5><p><strong>非唯一性索</strong>引扫描</p>\n<h5 id=\"fulltext\"><a href=\"#fulltext\" class=\"headerlink\" title=\"fulltext\"></a><strong>fulltext</strong></h5><p>全文索引检索</p>\n<h5 id=\"ref-or-null\"><a href=\"#ref-or-null\" class=\"headerlink\" title=\"ref_or_null\"></a><strong>ref_or_null</strong></h5><p>与ref方法类似，只是增加了null值的比较</p>\n<h5 id=\"unique-subquery\"><a href=\"#unique-subquery\" class=\"headerlink\" title=\"unique_subquery\"></a><strong>unique_subquery</strong></h5><p>用于where中的in形式子查询，子查询返回不重复值唯一值</p>\n<h5 id=\"index-subquery\"><a href=\"#index-subquery\" class=\"headerlink\" title=\"index_subquery\"></a><strong>index_subquery</strong></h5><p>用于in形式子查询使用到了辅助索引或者in常数列表，子查询可能返回重复值，可以使用索引将子查询去重</p>\n<h5 id=\"range\"><a href=\"#range\" class=\"headerlink\" title=\"range\"></a><strong><code>range</code></strong></h5><p><strong>索引范围扫描</strong>，常见于使用&gt;,&lt;,is null,between ,in ,like等运算符的查询中</p>\n<h5 id=\"index-merge\"><a href=\"#index-merge\" class=\"headerlink\" title=\"index_merge\"></a><strong>index_merge</strong></h5><p>表示查询使用了两个以上的索引，最后取交集或者并集，常见and ，or的条件使用了不同的索引</p>\n<h5 id=\"index\"><a href=\"#index\" class=\"headerlink\" title=\"index\"></a><strong><code>index</code></strong></h5><p>select结果列中使用到了索引，type会显示为index。<strong>全部索引扫描</strong>，把索引从头到尾扫一遍，常见于使用索引列就可以处理不需要读取数据文件的查询、可以使用索引排序或者分组的查询</p>\n<h5 id=\"all\"><a href=\"#all\" class=\"headerlink\" title=\"all\"></a><strong><code>all</code></strong></h5><p>这个就是全表扫描数据文件，然后再<strong>在<strong><strong>server</strong></strong>层进行过滤</strong>返回符合要求的记录</p>\n<h4 id=\"Extra参数\"><a href=\"#Extra参数\" class=\"headerlink\" title=\"Extra参数\"></a><strong>Extra参数</strong></h4><ul>\n<li><p><strong>Using filesort</strong></p>\n<p>使用了文件排序</p>\n</li>\n<li><p><strong>Using index</strong></p>\n<p>表示相应的SELECT查询中使用到了索引，避免访问表的数据行，这种查询的效率很高！</p>\n</li>\n<li><p><strong>Using where</strong></p>\n<p>MySQL将对InnoDB提取的结果在SQL Layer层进行过滤</p>\n</li>\n<li><p><strong>Using join buffer</strong></p>\n<p>使用了连接缓存</p>\n</li>\n</ul>\n<h2 id=\"优化\"><a href=\"#优化\" class=\"headerlink\" title=\"优化\"></a>优化</h2><p>创建索引的原则，判断组合索引失效场景</p>\n<h3 id=\"慢查询\"><a href=\"#慢查询\" class=\"headerlink\" title=\"慢查询\"></a>慢查询</h3><p><strong>查看是否开启慢查询功能</strong></p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\"># 查看是否开启慢查询日志</span>\n<span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'%slow_query%'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">show</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'long_query_time%'</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>slow_query_log：是否开启慢查询日志，1为开启，0为关闭</p>\n<p>log-slow-queries：旧版（5.6以下）MySQL数据库慢查询日志存储路径。</p>\n<p>slow-query-log-file：新版（5.6及以上）MySQL数据库慢查询日志存储路径。</p>\n<p>​\t\t不设置该参数，系统则会默认给一个文件host_name-slow.log</p>\n<p>long_query_time：慢查询阈值，当查询时间多于设定的阈值时，记录日志，单位秒</p>\n<h3 id=\"开启慢查询\"><a href=\"#开启慢查询\" class=\"headerlink\" title=\"开启慢查询\"></a>开启慢查询</h3><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\"># 开启慢查询日志</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> slow_query_log<span class=\"token operator\">=</span><span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 大于1秒钟的数据记录到慢日志中，如果设置为默认0，则会有大量的信息存储在磁盘中，磁盘很容易满</span>\n掉\n<span class=\"token comment\"># 如果设置不生效，建议配置在my.cnf配置文件中</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> long_query_time<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 记录没有索引的查询。</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> log_queries_not_using_indexes<span class=\"token operator\">=</span><span class=\"token keyword\">on</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"连接数max-connections\"><a href=\"#连接数max-connections\" class=\"headerlink\" title=\"连接数max_connections\"></a><strong>连接数</strong>max_connections</h3><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token comment\"># 查看 max_connections</span>\n<span class=\"token keyword\">show</span> <span class=\"token keyword\">global</span> variables <span class=\"token operator\">like</span> <span class=\"token string\">'max_connections'</span>\n<span class=\"token comment\"># 设置 max_connections（立即生效重启后失效）</span>\n<span class=\"token keyword\">set</span> <span class=\"token keyword\">global</span> max_connections <span class=\"token operator\">=</span> <span class=\"token number\">800</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 这台MySQL服务器最大连接数是256，然后查询一下服务器使用过的最大连接数：</span>\n<span class=\"token keyword\">show</span> <span class=\"token keyword\">global</span> <span class=\"token keyword\">status</span> <span class=\"token operator\">like</span> <span class=\"token string\">'Max_used_connections'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># MySQL服务器过去的最大连接数是245，没有达到服务器连接数上限256，应该没有出现1040错误，</span>\n比较理想的设置是：Max_used_connections <span class=\"token operator\">/</span> max_connections <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token operator\">%</span> ≈ <span class=\"token number\">85</span><span class=\"token operator\">%</span>\n最大连接数占上限连接数的<span class=\"token number\">85</span><span class=\"token operator\">%</span>左右，如果发现比例在<span class=\"token number\">10</span><span class=\"token operator\">%</span>以下，MySQL服务器连接数上限设置的过高\n了<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>","categories":[],"tags":[]}