{"title":"Kubernetes(五)-集群核心概念Service","slug":"Kubernetes-五-集群核心概念Service","date":"2023-06-26T14:50:33.000Z","updated":"2024-04-22T07:21:14.891Z","comments":true,"path":"api/articles/Kubernetes-五-集群核心概念Service.json","excerpt":"Service概念及作用","covers":null,"content":"<p>Service概念及作用</p>\n<span id=\"more\"></span>\n\n<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><blockquote>\n<p>使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。</p>\n</blockquote>\n<ul>\n<li>通过service为pod客户端提供访问pod方法，即可客户端访问pod入口</li>\n<li>通过标签动态感知pod IP地址变化等</li>\n<li>防止pod失联</li>\n<li>定义访问pod访问策略</li>\n<li>通过label-selector相关联</li>\n<li>通过Service实现Pod的负载均衡（TCP&#x2F;UDP 4层）</li>\n<li>底层实现由kube-proxy通过userspace、iptables、ipvs三种代理模式</li>\n</ul>\n<h2 id=\"service类型\"><a href=\"#service类型\" class=\"headerlink\" title=\"service类型\"></a>service类型</h2><ul>\n<li><p><strong>ClusterIP</strong></p>\n<ul>\n<li>默认，分配一个集群内部可以访问的虚拟IP</li>\n</ul>\n</li>\n<li><p><strong>NodePort</strong></p>\n<ul>\n<li>在每个Node上分配一个端口作为外部访问入口</li>\n<li>nodePort端口范围为:30000-32767</li>\n</ul>\n</li>\n<li><p><strong>LoadBalancer</strong></p>\n<ul>\n<li>工作在特定的Cloud Provider上，例如Google Cloud，AWS，OpenStack</li>\n</ul>\n</li>\n<li><p><strong>ExternalName</strong></p>\n<ul>\n<li>表示把集群外部的服务引入到集群内部中来，即实现了集群内部pod和集群外部的服务进行通信</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Service参数\"><a href=\"#Service参数\" class=\"headerlink\" title=\"Service参数\"></a>Service参数</h3><ul>\n<li><p><strong><code>port</code></strong>             访问service使用的端口</p>\n</li>\n<li><p><strong><code>targetPort</code></strong>  Pod中容器端口</p>\n</li>\n<li><p><strong><code>nodePort</code></strong>   通过Node实现外网用户访问k8s集群内service (30000-32767)</p>\n</li>\n</ul>\n<h2 id=\"Service创建\"><a href=\"#Service创建\" class=\"headerlink\" title=\"Service创建\"></a>Service创建</h2><h3 id=\"NodePort类型\"><a href=\"#NodePort类型\" class=\"headerlink\" title=\"NodePort类型\"></a>NodePort类型</h3><p>创建资源清单文件</p>\n<figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 05_create_nodeport_service_app.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> c1\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.15<span class=\"token punctuation\">-</span>alpine\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n    <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30001</span>\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8060</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>\n\n<p>应用资源清单文件</p>\n<figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> 05_create_nodeport_service_app.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></div></figure>\n\n<p>验证创建</p>\n<figure><div class=\"code-wrapper\"><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">kubectl get deployment.apps\nkubectl get svc\nkubectl get endpoints<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></div></figure>\n","more":"<h2 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h2><blockquote>\n<p>使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。</p>\n</blockquote>\n<ul>\n<li>通过service为pod客户端提供访问pod方法，即可客户端访问pod入口</li>\n<li>通过标签动态感知pod IP地址变化等</li>\n<li>防止pod失联</li>\n<li>定义访问pod访问策略</li>\n<li>通过label-selector相关联</li>\n<li>通过Service实现Pod的负载均衡（TCP&#x2F;UDP 4层）</li>\n<li>底层实现由kube-proxy通过userspace、iptables、ipvs三种代理模式</li>\n</ul>\n<h2 id=\"service类型\"><a href=\"#service类型\" class=\"headerlink\" title=\"service类型\"></a>service类型</h2><ul>\n<li><p><strong>ClusterIP</strong></p>\n<ul>\n<li>默认，分配一个集群内部可以访问的虚拟IP</li>\n</ul>\n</li>\n<li><p><strong>NodePort</strong></p>\n<ul>\n<li>在每个Node上分配一个端口作为外部访问入口</li>\n<li>nodePort端口范围为:30000-32767</li>\n</ul>\n</li>\n<li><p><strong>LoadBalancer</strong></p>\n<ul>\n<li>工作在特定的Cloud Provider上，例如Google Cloud，AWS，OpenStack</li>\n</ul>\n</li>\n<li><p><strong>ExternalName</strong></p>\n<ul>\n<li>表示把集群外部的服务引入到集群内部中来，即实现了集群内部pod和集群外部的服务进行通信</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Service参数\"><a href=\"#Service参数\" class=\"headerlink\" title=\"Service参数\"></a>Service参数</h3><ul>\n<li><p><strong><code>port</code></strong>             访问service使用的端口</p>\n</li>\n<li><p><strong><code>targetPort</code></strong>  Pod中容器端口</p>\n</li>\n<li><p><strong><code>nodePort</code></strong>   通过Node实现外网用户访问k8s集群内service (30000-32767)</p>\n</li>\n</ul>\n<h2 id=\"Service创建\"><a href=\"#Service创建\" class=\"headerlink\" title=\"Service创建\"></a>Service创建</h2><h3 id=\"NodePort类型\"><a href=\"#NodePort类型\" class=\"headerlink\" title=\"NodePort类型\"></a>NodePort类型</h3><p>创建资源清单文件</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 05_create_nodeport_service_app.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> c1\n        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.15<span class=\"token punctuation\">-</span>alpine\n        <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> NodePort\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> TCP\n    <span class=\"token key atrule\">nodePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30001</span>\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8060</span>\n    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>应用资源清单文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">kubectl apply <span class=\"token parameter variable\">-f</span> 05_create_nodeport_service_app.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>验证创建</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">kubectl get deployment.apps\nkubectl get svc\nkubectl get endpoints<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>","categories":[],"tags":[]}